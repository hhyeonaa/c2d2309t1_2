<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mappers.board">
	<select id="select" parameterType="map" resultType="map">
		SELECT *
		  FROM PRODUCT
		 WHERE PRO_NO = #{proNo}
	</select>
	<insert id="insertBoard" parameterType="String" statementType="CALLABLE">
		{CALL PROC_INSERT_BOARD(
	        #{jsonParams, jdbcType=VARCHAR}
		)}
	</insert>
	<insert id="insertPreBoard" parameterType="map">
	    INSERT INTO PRODUCT_PRE(PRE_MEMID, PRE_BONO, PRE_TC, PRE_CATE, PRE_NAME, PRE_PRICE, PRE_CONTENT, PRE_DATE)
	    VALUES (
	        #{preMemid},
	        (SELECT IFNULL(MAX(CAST(PRE_BONO AS UNSIGNED)), 0) + 1 FROM (SELECT * FROM PRODUCT_PRE) AS TEMP),
	        #{preTc},
	        #{preCate},
	        #{preName},
	        #{prePrice},
	        #{preContent},
	        DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
	    )
	</insert>
	<insert id="insertPreAuction" parameterType="map">
		INSERT INTO AUCTION_PRE(PRA_MEMID,PRA_CATE,PRA_BONO,PRA_NAME,PRA_CONTENT,PRA_SP,PRA_INP,PRA_BP,PRA_TC,PRA_DATE)
		VALUES(
			#{praMemid},
			#{praCate},
			(SELECT IFNULL(MAX(CAST(PRA_BONO AS UNSIGNED)), 0) + 1 FROM (SELECT * FROM AUCTION_PRE) AS TEMP),
			#{praName},
			#{praContent},
			#{praSp},
			#{praInp},
			#{praBp},
			#{praTc},
			DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		)
	</insert>
	
	<select id="selectBoard" resultType="map" parameterType="map">
		SELECT *
		  FROM PRODUCT
		  JOIN IMAGE
		    ON PRO_NO = IMG_PRONO 
		  JOIN CODE
		    ON PRO_TC = CONCAT(CO_TYPE,CO_NO) 
		 WHERE IMG_NO = 1
		 <if test="proTc == 'MM1'">
		 	AND PRO_TC = 'MM1'
		 </if>
		 <if test="proTc == 'MM2'">
		 	AND PRO_TC = 'MM2'
		 </if>
		 <if test="proTc == 'MM3'">
		 	AND PRO_TC = 'MM3'
		 </if>
 		 <if test="proTc == 'MM4'">
		 	AND PRO_TC = 'MM4'
		 </if>
		 ORDER BY PRO_DATE DESC
	</select>
	
<!-- 	<select id="selectSaleBoard" resultType="map"> -->
<!-- 		SELECT * -->
<!-- 		  FROM PRODUCT -->
<!-- 		  JOIN IMAGE -->
<!-- 		    ON PRO_NO = IMG_PRONO  -->
<!-- 		  JOIN CODE -->
<!-- 		    ON PRO_TC = CONCAT(CO_TYPE,CO_NO)  -->
<!-- 		 WHERE IMG_NO = 1 -->
<!-- 		   AND PRO_TC = 'MM1' -->
<!-- 		 ORDER BY PRO_DATE DESC -->
<!-- 	</select> -->
	
	<!-- 성엽 작업 시작 -->
	
	<select id="selectBuyBoard" resultType="map">
		SELECT *
		  FROM PRODUCT
		  JOIN IMAGE
		    ON PRO_NO = IMG_PRONO
		 WHERE IMG_NO = 1
			AND PRO_TC = 'MM2'
	</select>
	
	<!-- 성엽 작업 끝 -->
	
	
	<select id="selectBoardDetail" parameterType="map" resultType="map">
		SELECT *
		  FROM PRODUCT p
		  JOIN (select IMG_PRONO, group_concat(IMG_NAME order by IMG_NO separator '|') IMG_NAMES from IMAGE group by IMG_PRONO) i
		    ON p.PRO_NO = i.IMG_PRONO
		 WHERE PRO_WR = #{proWr} AND PRO_DATE = #{proDate}
	</select>
	<update id="upHits" parameterType="map">
		UPDATE PRODUCT
		   SET PRO_HITS = PRO_HITS + 1
		 WHERE PRO_WR = #{proWr} AND PRO_DATE = #{proDate} 
	</update>
<!-- 	<select id="selectDivideBoard" resultType="map"> -->
<!-- 		SELECT * -->
<!-- 		  FROM PRODUCT -->
<!-- 		  JOIN IMAGE -->
<!-- 		    ON PRO_NO = IMG_PRONO  -->
<!-- 		  JOIN CODE -->
<!-- 		    ON PRO_TC = CONCAT(CO_TYPE,CO_NO)  -->
<!-- 		 WHERE IMG_NO = 1 -->
<!-- 		   AND PRO_TC = 'MM3' -->
<!-- 		 ORDER BY PRO_DATE DESC  -->
<!-- 	</select> -->
	<select id="getImgMap" resultType="map">
		SELECT *
		  FROM IMAGE
		 WHERE IMG_PRONO = #{proNo};
	</select>
	<select id="deleteBoard" parameterType="map" statementType="CALLABLE">
		{CALL PROC_DELETE_BOARD(
	        #{proNo, mode=IN, jdbcType=VARCHAR},
	        #{success, mode=OUT, jdbcType=VARCHAR}
		)}		
	</select>
	<select id="selectAddress" resultType="map">
		SELECT A.ADD_NO,A.ADD_POST,A.ADD_NAME,A.ADD_DETAIL,A.ADD_NICK,M.MEM_ID
		  FROM ADDRESS A
		  JOIN MEMBERS M
		    ON A.MEM_NO = M.MEM_NO
		 WHERE M.MEM_ID = #{id}  
	</select>
</mapper>